---
title: 国际化项目中自动化语言包的vite插件
layout: post
date: "2021-11-23"
image:
headerImage: false
tag:
  - vite plugin
  - react
  - i18n
star: true
category: blog
author: LZS_911
description: blog
---

## 前言

---

在包含国际化的前端项目中, 需要提取出对应语言的文本数据, 在代码中使用函数调用的方式来添加文本[(react 国际化插件](https://react.i18next.com/)). 这样在开发过程中每添加一行文本信息就得去对应的语言包文件中添加对应的数据, 若只有中文和英语还好, 只需要添加两种语言数据, 可当对应的语言包很多时, 有没有一种简单的方式来自动添加呢?

## `vite` 插件介绍

---

官方文档链接: <https://cn.vitejs.dev/guide/api-plugin.html>

`vite` 插件通常的惯例为返回一个实际插件对象的工厂函数, 该函数可以接受允许用户自定义插件行为的选项.

在这里只需要用到 `vite` 的独有钩子函数 [handleHotUpdate](https://cn.vitejs.dev/guide/api-plugin.html#handlehotupdate). 它可以执行自定义 `HMR` 更新处理, 在代码文件更新时去添加或者修改语言包文件.

## 准备

---

1. 定义用户自定义插件的选项

   |    name     |                     defaultValue                     |   type   |      description      |
   | :---------: | :--------------------------------------------------: | :------: | :-------------------: |
   |   funName   |                          t                           |  string  |  function call name   |
   |  splitCode  |                          #                           |  string  |      split code       |
   | languageDir |           ['locale/zh-CN', 'locale/en-US']           | string[] | language package path |
   |   include   | ['src/\*\*/\*.{js,jsx,ts,tsx}', '!src/\*\*/\*.d.ts'] | string[] |   include directory   |

2. 代码解析工具 —— `babel`

   - [babel-parse(parseSync)](https://babeljs.io/docs/en/babel-parser#docsNav): 将字符串格式的 `javascript` 源码解析为 `AST` 结构对象, 同时也支持 `JSX、 Flow、 Typescript` (使用各种插件).
   - [babel-preset-typescript](https://babeljs.io/docs/en/babel-preset-typescript#docsNav): 支持 `parse` 来解析 `typescript` 类型文件的插件.
   - [babel-traverse](https://babeljs.io/docs/en/babel-traverse#docsNav): 遍历所有 `AST` 节点和更新节点.
   - [babel-generator](https://babeljs.io/docs/en/babel-generator#docsNav): 将 `AST` 转换为代码, `parse` 的逆向操作.
   - [babel-types](https://babeljs.io/docs/en/babel-types#docsNav): 手动构建 `AST` 和检查 `AST` 节点类型.

3. 其他工具
   - [fast-glob](https://www.npmjs.com/package/fast-glob): 根据指定的参数获取符合规则的所有文件名称, 用来排除无需执行自定义更新处理的文件(例如 `index.d.ts` 类型文件).
   - [prettier](https://www.npmjs.com/package/prettier): 在写入文件前对字符串格式的代码进行格式化.
   - [chalk](https://www.npmjs.com/package/chalk): 控制台输出文本高亮显示, 用来显示错误信息.
   - [fs](http://nodejs.cn/api/fs.html): `node` 中操作文件的 `API`.

## 实现

---

### 构建工厂函数

```typescript
export default function (userOptions: Options = {}): Plugin {
  return {
    name: "vite-plugin-watch-i18",
    async handleHotUpdate(ctx) {
      //get options default value
      const {
        funName = "t",
        splitCode = "#",
        languageDir = ["locale/zh-CN", "locale/en-US"],
        include = ["src/**/*.{js,jsx,ts,tsx}", "!src/**/*.d.ts"],
      } = userOptions;
      //...
    },
  };
}
```

### 排除无需处理文件

```typescript
import fg from "fast-glob";
const filePath = ctx.file;
const allFile = await fg(include);
if (!allFile.includes(filePath)) {
  return;
}
```

### 处理源代码文件
