{"pageProps":{"post":{"title":"如何使用jest测试 Date.now?","date":"2022-07-06","slug":"如何使用jest测试 Date.now","author":"LZS_911","content":"<p>最近工作中遇到一个需求, 需要在 <code>post</code> 接口 <code>request</code> 的 <code>headers</code> 中塞一个 <code>timestamp</code> 字段, 值为当前时间的时间戳. 实现方式很简单, 只需要在 <code>api</code> 封装的 <code>post</code> 方法的 <code>headers</code> 中新增 <code>timestamp: Date.now()</code> 即可. 然后想当然的在单元测试关于 <code>headers</code> 的 <code>toEqual</code> 中同时也加上该字段, 跑一遍 <code>ut</code>, 发现测试能过, 于是开了一个 <code>MR</code> 指给复审人, 可是此时却发现 <code>ci</code> 上的 <code>ut</code> 关于这里的断言却是有错误的. 在本地多跑几遍后, 发现确实有可能出现 <code>Date.now()</code> 对应不上的情况.</p>\n<p>后续仔细一想发现跑不过其实应该才是普遍的现象, 毕竟在给对象添加 <code>timestamp</code> 字段的时间戳不可能与 <code>toEqual</code> 时的时间戳完全一致. 找到错误原因后解决的思路就很简单了, 只需要在 <code>ut</code> 时给 <code>Date.now()</code> 一个固定值就好了.</p>\n<p>大致代码:</p>\n<pre><code class=\"language-javascript\">const MOCK_DATE_NOW = 1530518207007;\n\nconst realDateNow = Date.now.bind(global.Date);\n\ndescribe('api test', () => {\n  beforeAll(() => {\n    const dateNowStub = jest.fn(() => MOCK_DATE_NOW);\n    global.Date.now = dateNowStub;\n  });\n\n  afterAll(() => {\n    global.Date.now = realDateNow;\n  });\n}\n\n</code></pre>","ogImage":{"url":"/assets/blog/image/cover.jpg"},"coverImage":"/assets/blog/image/cover.jpg","theme":"awesome-green","tag":["jest","javascript"]}},"__N_SSG":true}