(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[520],{3930:(e,t,n)=>{Promise.resolve().then(n.bind(n,6798)),Promise.resolve().then(n.bind(n,5099))},5099:(e,t,n)=>{"use strict";n.d(t,{ThemeLoader:()=>o});var r=n(2115);function o(e){let{theme:t}=e;return(0,r.useEffect)(()=>{let e=document.createElement("link");return e.rel="stylesheet",e.type="text/css",e.href="/theme/".concat(t,".min.css"),document.head.appendChild(e),()=>{document.head.removeChild(e)}},[t]),null}},6798:(e,t,n)=>{"use strict";n.d(t,{default:()=>w});var r=n(5155),o=n(2115),a=n(9509);let l=a.env.NEXT_PUBLIC_GITHUB_CLIENT_ID,i=(a.env.NEXT_PUBLIC_GH_CLIENT_SECRET,a.env.NEXT_PUBLIC_GITHUB_TOKEN),s=a.env.NEXT_PUBLIC_REPO_OWNER,c=a.env.NEXT_PUBLIC_REPO_NAME,d=e=>"Comments for: ".concat(e);async function u(e){try{var t,n,r;let o='\n      query {\n        repository(owner: "'.concat(s,'", name: "').concat(c,'") {\n          discussions(first: 100, states: OPEN) {\n            nodes {\n              id\n              number\n              title\n            }\n          }\n        }\n      }\n    '),a=await fetch("https://api.github.com/graphql",{method:"POST",headers:{Authorization:"bearer ".concat(i||""),"Content-Type":"application/json"},body:JSON.stringify({query:o})}),l=await a.json(),u=((null==l||null==(r=l.data)||null==(n=r.repository)||null==(t=n.discussions)?void 0:t.nodes)||[]).find(t=>t.title===d(e));if(u)return{id:u.id,number:u.number};return null}catch(e){return console.error("获取或创建讨论异常:",e),null}}async function h(e){var t,n,r,o,a,l,u;let h='\n      query {\n        repository(owner: "'.concat(s,'", name: "').concat(c,'") {\n          discussionCategories(first: 10) {\n            nodes {\n              id\n              name\n            }\n          }\n        }\n      }\n    '),m=await fetch("https://api.github.com/graphql",{method:"POST",headers:{Authorization:"bearer ".concat(i||""),"Content-Type":"application/json"},body:JSON.stringify({query:h})}),p=await m.json(),y=((null==p||null==(r=p.data)||null==(n=r.repository)||null==(t=n.discussionCategories)?void 0:t.nodes)||[])[0];if(!y)return console.error("无法获取讨论分类"),null;let b='\n      query {\n        repository(owner: "'.concat(s,'", name: "').concat(c,'") {\n          id\n        }\n      }\n    '),g=await fetch("https://api.github.com/graphql",{method:"POST",headers:{Authorization:"bearer ".concat(i||""),"Content-Type":"application/json"},body:JSON.stringify({query:b})}),x=await g.json(),v=null==x||null==(a=x.data)||null==(o=a.repository)?void 0:o.id;if(!v)return console.error("无法获取仓库ID:",null==x?void 0:x.errors),null;let f='\n      mutation {\n        createDiscussion(input: {\n          repositoryId: "'.concat(v,'",\n          categoryId: "').concat(y.id,'",\n          body: "这是文章 ').concat(e,' 的评论区",\n          title: "').concat(d(e),'"\n        }) {\n          discussion {\n            id\n            number\n          }\n        }\n      }\n    '),w=await fetch("https://api.github.com/graphql",{method:"POST",headers:{Authorization:"bearer ".concat(i||""),"Content-Type":"application/json"},body:JSON.stringify({query:f})}),j=await w.json(),N=null==j||null==(u=j.data)||null==(l=u.createDiscussion)?void 0:l.discussion;return N?{id:N.id,number:N.number}:(console.error("创建讨论失败:",null==j?void 0:j.errors),console.error("创建讨论请求详情:",{repositoryId:v,categoryId:y.id,title:d(e)}),null)}async function m(e){try{var t,n,r;let o=await fetch("https://api.github.com/graphql",{method:"POST",headers:{Authorization:"bearer ".concat(i||""),"Content-Type":"application/json"},body:JSON.stringify({query:'\n      query {\n        node(id: "'.concat(e,'") {\n          ... on Discussion {\n            comments(first: 100) {\n              nodes {\n                id\n                author {\n                  login\n                  avatarUrl\n                  url\n                }\n                body\n                bodyHTML\n                createdAt\n                replyToId: replyTo {\n                  id\n                }\n                replies(first: 100) {\n                  nodes {\n                    id\n                    author {\n                      login\n                      avatarUrl\n                      url\n                    }\n                    body\n                    bodyHTML\n                    createdAt\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    ')})}),a=await o.json();return((null==a||null==(r=a.data)||null==(n=r.node)||null==(t=n.comments)?void 0:t.nodes)||[]).map(e=>{var t,n,r,o,a,l,i;return{id:e.id,author:{login:(null==(t=e.author)?void 0:t.login)||"匿名用户",avatarUrl:null==(n=e.author)?void 0:n.avatarUrl,url:null==(r=e.author)?void 0:r.url},content:e.body,bodyHTML:e.bodyHTML,createdAt:e.createdAt,replyToId:null==(o=e.replyToId)?void 0:o.id,replies:null==(l=e.replies)||null==(a=l.nodes)?void 0:a.map(e=>{var t,n,r;return{id:e.id,author:{login:(null==(t=e.author)?void 0:t.login)||"匿名用户",avatarUrl:null==(n=e.author)?void 0:n.avatarUrl,url:null==(r=e.author)?void 0:r.url},content:e.body,bodyHTML:e.bodyHTML,createdAt:e.createdAt}}),reactions:(null==(i=e.reactionGroups)?void 0:i.map(e=>({type:e.content,count:e.users.totalCount})))||[]}})}catch(e){return console.error("获取评论异常:",e),[]}}async function p(e,t,n,r){try{var o,a,l,i,s,c;let d='\n      mutation {\n        addDiscussionComment(input: {\n          discussionId: "'.concat(e,'",\n          body: "').concat(t.replace(/"/g,'\\"'),'"\n          ').concat(r?', replyToId: "'.concat(r,'"'):"","\n        }) {\n          comment {\n            id\n            author {\n              login\n              avatarUrl\n              url\n            }\n            body\n            createdAt\n            replyTo {\n              id\n            }\n          }\n        }\n      }\n    "),u=await fetch("https://api.github.com/graphql",{method:"POST",headers:{Authorization:"bearer ".concat(n),"Content-Type":"application/json"},body:JSON.stringify({query:d})}),h=await u.json();if(h.errors)return console.error("添加评论错误:",h.errors),null;let m=null==h||null==(a=h.data)||null==(o=a.addDiscussionComment)?void 0:o.comment;if(m)return{id:m.id,author:{login:(null==(l=m.author)?void 0:l.login)||"匿名用户",avatarUrl:null==(i=m.author)?void 0:i.avatarUrl,url:null==(s=m.author)?void 0:s.url},content:m.body,createdAt:m.createdAt,replyToId:null==(c=m.replyTo)?void 0:c.id};return null}catch(e){return console.error("添加评论异常:",e),null}}async function y(e){try{let t=await fetch("https://api.github.com/user",{headers:{Authorization:"token ".concat(e),Accept:"application/json"}});if(!t.ok)return console.error("获取用户信息失败:",t.statusText),null;return await t.json()}catch(e){return console.error("获取用户信息异常:",e),null}}var b=n(6766),g=n(3319);let x=e=>{let{onSubmit:t,isSubmitting:n,initialContent:a="",placeholder:l="写下你的评论...",buttonText:i="提交评论",userInfo:s}=e,[c,d]=(0,o.useState)(a);return(0,r.jsxs)("div",{className:"mt-2 bg-white rounded-lg p-3 shadow-sm",children:[s&&(0,r.jsxs)("div",{className:"mb-2 flex items-center",children:[(0,r.jsx)(b.default,{src:s.avatarUrl,alt:s.login,className:"w-8 h-8 rounded-full mr-2 border-2 border-gray-100",width:32,height:32}),(0,r.jsx)("span",{className:"font-medium text-gray-800 text-sm",children:s.login})]}),(0,r.jsx)("textarea",{value:c,onChange:e=>d(e.target.value),className:"w-full border border-gray-200 rounded-lg p-2 min-h-[80px] focus:ring-1 focus:ring-blue-500 focus:border-transparent resize-none text-sm",placeholder:l,disabled:n}),(0,r.jsx)("button",{onClick:()=>{t(c),d("")},disabled:n||!c.trim(),className:"mt-2 bg-black text-white px-4 py-1.5 text-sm rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer",children:n?"提交中...":i})]})},v=e=>{let{comment:t,onReply:n,userInfo:a,isSubmitting:l,level:i=0}=e,[s,c]=(0,o.useState)(!1);return(0,r.jsx)("div",{className:"bg-white rounded-lg shadow-sm transition-all ".concat(i>0?"ml-6 mt-2 border-l-2 border-gray-100":"border border-gray-100"),children:(0,r.jsxs)("div",{className:"p-3",children:[(0,r.jsxs)("div",{className:"flex items-center mb-2",children:[(0,r.jsx)(b.default,{src:t.author.avatarUrl,alt:t.author.login,className:"w-8 h-8 rounded-full mr-2 border-2 border-gray-100",width:32,height:32}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("a",{href:t.author.url,target:"_blank",rel:"noopener noreferrer",className:"font-medium text-gray-900 hover:text-blue-600 transition-colors text-sm truncate block",children:t.author.login}),(0,r.jsx)("div",{className:"text-xs text-gray-500",children:(0,g.GP)(new Date(t.createdAt),"yyyy-MM-dd HH:mm:ss")})]})]}),(0,r.jsx)("div",{className:"prose max-w-none mb-2 text-sm text-gray-800 leading-normal",children:t.content}),a&&0===i&&(0,r.jsxs)("div",{className:"mt-2 pt-2 border-t border-gray-50",children:[(0,r.jsxs)("button",{onClick:()=>c(!s),className:"text-xs text-gray-600 hover:text-blue-600 transition-colors flex items-center cursor-pointer",children:[(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3 mr-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"})}),s?"取消回复":"回复"]}),s&&(0,r.jsx)(x,{onSubmit:e=>{n(e,t.id),c(!1)},isSubmitting:l,placeholder:"回复 @".concat(t.author.login,"..."),buttonText:"提交回复",userInfo:a})]})]})})},f=e=>{var t;let{comment:n,onReply:a,userInfo:l,isSubmitting:i}=e,[s,c]=(0,o.useState)(!1),d=n.replies&&n.replies.length>3,u=s?n.replies:null==(t=n.replies)?void 0:t.slice(0,3);return(0,r.jsxs)("div",{children:[(0,r.jsx)(v,{comment:n,onReply:a,userInfo:l,isSubmitting:i}),null==u?void 0:u.map(e=>(0,r.jsx)(v,{comment:e,onReply:a,userInfo:l,isSubmitting:i,level:1},e.id)),d&&(0,r.jsxs)("button",{onClick:()=>c(!s),className:"ml-6 mt-2 text-xs text-blue-600 hover:text-blue-800 transition-colors flex items-center cursor-pointer",children:[(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3 mr-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:s?(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 15l7-7 7 7"}):(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})}),s?"收起回复":"展开其他 ".concat(n.replies.length-3," 条回复")]})]})},w=e=>{let{slug:t}=e,[n,a]=(0,o.useState)([]),[i,s]=(0,o.useState)(!0),[c,d]=(0,o.useState)(null),[b,g]=(0,o.useState)(!1),[v,w]=(0,o.useState)(null),j=(0,o.useCallback)(async e=>{let t=await u(e);return t?m(t.id):[]},[]),N=(0,o.useCallback)(async(e,t,n,r)=>{let o=await u(e);if(o||(o=await h(e)),!o)throw Error("无法获取或创建讨论");return p(o.id,t,n,r)},[]);(0,o.useEffect)(()=>{let e=async()=>{try{s(!0),a(await j(t))}catch(e){d("获取评论失败，请稍后再试"),console.error("Error fetching comments:",e)}finally{s(!1)}},n=async()=>{let e=document.cookie.split("; ").find(e=>e.startsWith("github_token="));if(e){let t=e.split("=")[1];try{let e=await y(t);e?w({login:e.login,avatarUrl:e.avatar_url}):w(null)}catch(e){console.error("Error fetching user info:",e),w(null)}}else w(null)};t&&(e(),n())},[j,t]);let T=async(e,n)=>{if(e.trim())try{g(!0);let r=document.cookie.split("; ").find(e=>e.startsWith("github_token="));if(!r)throw Error("请先登录后再评论");let o=r.split("=")[1],l=await N(t,e,o,n);if(!l)throw Error(l||"提交评论失败");a(await j(t))}catch(e){d(e instanceof Error?e.message:"提交评论失败，请稍后再试"),console.error("Error submitting comment:",e)}finally{g(!1)}},C=n.reduce((e,t)=>{if(t.replyToId){let e=n.find(e=>e.id===t.replyToId);e&&(Array.isArray(e.replies)||(e.replies=[]),e.replies.push(t))}else e.push(t);return e},[]);return(0,r.jsxs)("div",{className:"mt-8 max-w-3xl mx-auto",children:[(0,r.jsx)("h3",{className:"text-xl font-bold mb-4 text-gray-900",children:"评论区"}),i?(0,r.jsxs)("div",{className:"text-center py-6",children:[(0,r.jsx)("div",{className:"inline-block animate-spin rounded-full h-6 w-6 border-3 border-gray-200 border-t-blue-600"}),(0,r.jsx)("p",{className:"mt-2 text-sm text-gray-600",children:"加载评论中..."})]}):c?(0,r.jsx)("div",{className:"bg-red-50 text-red-600 p-3 rounded-lg text-sm",children:c}):(0,r.jsxs)(r.Fragment,{children:[v?(0,r.jsx)(x,{onSubmit:e=>T(e),isSubmitting:b,userInfo:v}):(0,r.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg text-center",children:[(0,r.jsx)("p",{className:"mb-3 text-sm text-gray-700",children:"登录后参与讨论"}),(0,r.jsxs)("button",{onClick:()=>{document.cookie="redirect_url=".concat(window.location.pathname,"; path=/; max-age=300"),window.location.href=function(){let e="".concat(window.location.origin,"/api/auth/github/callback");return"https://github.com/login/oauth/authorize?client_id=".concat(l,"&redirect_uri=").concat(encodeURIComponent(e),"&scope=public_repo")}()},className:"bg-black text-white px-4 py-1.5 text-sm rounded-lg transition-colors inline-flex items-center cursor-pointer",children:[(0,r.jsx)("svg",{className:"w-4 h-4 mr-2",viewBox:"0 0 24 24",fill:"currentColor",children:(0,r.jsx)("path",{d:"M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"})}),"使用 GitHub 登录"]})]}),(0,r.jsx)("div",{className:"mt-4 space-y-2",children:0===C.length?(0,r.jsx)("div",{className:"text-center py-6 text-sm text-gray-500",children:"暂无评论，来添加第一条评论吧！"}):C.map(e=>(0,r.jsx)(f,{comment:e,onReply:T,userInfo:v,isSubmitting:b},e.id))})]})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[766,62,441,684,358],()=>t(3930)),_N_E=e.O()}]);