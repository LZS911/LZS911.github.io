(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[502],{907:(e,t,a)=>{Promise.resolve().then(a.bind(a,8484))},1928:(e,t,a)=>{"use strict";a.d(t,{A:()=>l});var r=a(5155),n=a(6766);let l=e=>{let{name:t,picture:a,showName:l,...o}=e;return(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)(n.default,{src:a,className:" rounded-full",alt:t,...o}),l?(0,r.jsx)("div",{className:"text-xl font-bold",children:t}):null]})}},8484:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>J});var r=a(5155),n=a(2115),l=a(7660);class o{async uploadImage(e,t){try{let a=Date.now(),r=new FormData;r.append("image",e,t||"image-".concat(a,".png"));let n=await fetch("/api/images",{method:"POST",body:r});if(!n.ok)throw Error("服务器端图片上传失败");let l=await n.json(),o={path:l.url,content:"",name:l.fileName,blobUrl:l.url};return this.uploadedImages.push(o),l.url+"#"+"/assets/blog/posts/".concat(l.fileName)}catch(e){throw console.error("处理图片失败:",e),Error("处理图片失败")}}deleteImage(e){let t=e.split("#")[0],a=this.uploadedImages.findIndex(e=>e.path===t||e.blobUrl===t);-1!==a&&this.uploadedImages.splice(a,1)}async restoreImages(e){this.clearUploadedImages(),this.uploadedImages=[...e]}getUploadedImages(){return[...this.uploadedImages]}clearUploadedImages(){this.uploadedImages=[]}addRestoredImage(e){this.uploadedImages.push(e)}constructor(){this.uploadedImages=[]}}let s=null;function c(){return s||(s=new o)}var i=a(9509),d=a(9641).Buffer;let u=new l.E({auth:i.env.NEXT_PUBLIC_GITHUB_TOKEN}),g=i.env.NEXT_PUBLIC_GITHUB_OWNER||"LZS911",h=i.env.NEXT_PUBLIC_REPO_NAME||"LZS911.github.io";async function f(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"main",{data:t}=await u.git.getRef({owner:g,repo:h,ref:"heads/".concat(e)}),a="blog-post-".concat(Date.now());return await u.git.createRef({owner:g,repo:h,ref:"refs/heads/".concat(a),sha:t.object.sha}),a}async function m(e,t){let a=[];try{for(let r of e){if(!r.content){console.error("图片 ".concat(r.name," 没有内容，跳过上传"));continue}let e="public/assets/blog/posts/".concat(r.name);await u.repos.createOrUpdateFileContents({owner:g,repo:h,path:e,message:"chore: upload image ".concat(r.name),content:r.content,branch:t}),a.push(e)}return{success:!0,uploadedPaths:a}}catch(e){return console.error("上传图片失败:",e),{success:!1,uploadedPaths:a}}}async function p(e,t,a,r){try{return await u.repos.createOrUpdateFileContents({owner:g,repo:h,path:a,message:'feat: add article "'.concat(e,'"'),content:d.from(t).toString("base64"),branch:r}),!0}catch(e){return console.error("创建文章文件失败:",e),!1}}async function b(e,t,a){try{let{data:r}=await u.pulls.create({owner:g,repo:h,title:"Blog: ".concat(e),head:t,base:"main",body:"添加新博客文章: ".concat(e).concat(a>0?"\n\n包含 ".concat(a," 张图片"):"")});return{success:!0,url:r.html_url}}catch(e){return console.error("创建 PR 失败:",e),{success:!1}}}async function y(e){let{title:t,content:a,path:r}=e;try{let e=await f(),n=c(),l=n.getUploadedImages(),{success:o,uploadedPaths:s}=await m(l,e);if(!o&&l.length>0)throw Error("上传图片失败");if(!await p(t,a,r,e))throw Error("创建文章文件失败");let{success:i,url:d}=await b(t,e,l.length);if(!i)throw Error("创建 PR 失败");n.clearUploadedImages();try{await fetch("/api/preview/cleanup",{method:"POST"})}catch(e){console.warn("清理预览失败，但不影响主流程:",e)}return{url:d,uploadedImages:s}}catch(e){throw console.error("创建 PR 失败:",e),Error("创建 PR 失败")}}var w=a(4514),x=a(8984),v=a(1455),k=a(9086),S=a(6309),N=a(2431),j=a(8701),C=a(39);async function I(e){return(await (0,w.l)().use(x.A).use(v.A).use(k.A).use(C.A).use(S.A).use(j.A).use(N.A).process(e)).toString()}let E=["arknights","awesome-green","channing-cyan","Chinese-red","condensed-night-purple","cyanosis","devui-blue","fancy","geek-black","github","greenwillow","healer-readable","hydrogen","juejin","jzman","mk-cute","nico","orange","qklhk-chocolate","scrolls-light","simplicity-green","smartblue","v-green","vue-pro","vuepress"];var U=a(3319);let _=(e,t,a,r)=>"---\ntitle: ".concat(e,'\nlayout: post\ndate: "').concat((0,U.GP)(new Date,"yyyy-MM-dd"),'"\nimage:\nheaderImage: false\nstar: true\ncategory: ').concat(r,"\nauthor: LZS_911\ndescription: ").concat(r,"\nexcerpt: ''\ntheme: ").concat(a,"  \n---\n\n").concat(t,"\n"),P=(e,t,a)=>'\n<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>'.concat(e,' - 预览</title>\n  <link rel="stylesheet" href="/theme/').concat(a,".min.css\">\n</head>\n\n<style>\n    body {\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n      line-height: 1.6;\n      max-width: 800px;\n      margin: 0 auto;\n      padding: 20px;\n      color: #333;\n    }\n    \n    img {\n      max-width: 100%;\n      height: auto;\n      display: block;\n      margin: 20px 0;\n      border-radius: 4px;\n    }\n    \n    .markdown-content img {\n      box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n    }\n</style>\n\n<body>\n  <h1>").concat(e,'</h1>\n  <div class="markdown-content markdown-body-').concat(a,'">\n    ').concat(t,"\n  </div>\n</body>\n</html>\n  "),T=e=>{let{drafts:t,currentArticleId:a,showDraftList:n,onClose:l,onSwitchDraft:o,onDeleteDraft:s,onCreateNewDraft:c}=e;return n?(0,r.jsxs)("div",{className:"fixed top-16 right-6 bg-white dark:bg-gray-800 shadow-xl rounded-lg p-4 z-20 border border-gray-200 dark:border-gray-700 w-80",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-3",children:[(0,r.jsx)("h3",{className:"font-bold",children:"我的草稿"}),(0,r.jsx)("button",{onClick:l,className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:"\xd7"})]}),0===t.length?(0,r.jsx)("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"没有保存的草稿"}):(0,r.jsx)("ul",{className:"space-y-2 max-h-80 overflow-y-auto",children:t.map(e=>(0,r.jsxs)("li",{className:"p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 flex justify-between ".concat(e.id===a?"bg-blue-50 dark:bg-blue-900/20":""),children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("p",{className:"font-medium truncate",children:e.title||"无标题草稿"}),(0,r.jsx)("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:e.lastSaved?(0,U.GP)(new Date(e.lastSaved),"yyyy-MM-dd HH:mm:ss"):"未知时间"})]}),(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[e.id!==a&&(0,r.jsx)("button",{onClick:()=>o(e.id),className:"text-blue-500 hover:text-blue-600 text-sm",children:"切换"}),(0,r.jsx)("button",{onClick:()=>s(e.id),className:"text-red-500 hover:text-red-600 text-sm",children:"删除"})]})]},e.id))}),(0,r.jsx)("button",{onClick:c,className:"w-full mt-3 px-4 py-2 bg-blue-500 text-white text-sm rounded-full hover:bg-blue-600",children:"创建新草稿"})]}):null},D=e=>{let{title:t,onTitleChange:a,category:n,onCategoryChange:l,theme:o,onThemeChange:s,categories:c}=e;return(0,r.jsxs)("div",{className:"flex items-center gap-4 flex-1",children:[(0,r.jsx)("input",{type:"text",value:t,onChange:e=>a(e.target.value),placeholder:"请输入文章标题",className:"text-2xl font-bold px-4 py-2 w-1/3 border-none focus:outline-none focus:ring-0 dark:bg-gray-800 dark:text-white placeholder-gray-400"}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("select",{value:n,onChange:e=>l(e.target.value),className:"px-3 py-1.5 text-sm border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white bg-transparent",children:c.map(e=>(0,r.jsx)("option",{value:e,children:e},e))}),(0,r.jsx)("select",{value:o,onChange:e=>s(e.target.value),className:"px-3 py-1.5 text-sm border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white bg-transparent",children:E.map(e=>(0,r.jsx)("option",{value:e,children:e},e))})]})]})};var R=a(1928);let L=e=>{let{isAutoSaving:t,lastSaved:a,uploadProgress:n,loading:l,isUploading:o,isGeneratingPreview:s,onSaveDraft:c,onGeneratePreview:i,onSubmit:d,onShowDraftList:u}=e;return(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[n&&(0,r.jsx)("span",{className:"text-sm px-3 py-1 bg-blue-100 text-blue-800 rounded-full",children:n}),(0,r.jsx)(R.A,{name:"Ai.Haibara",picture:"/assets/blog/authors/haibara_2.jpg",height:40,width:40}),(0,r.jsx)("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:t?"自动保存中...":a?"上次保存: ".concat((0,U.GP)(a,"yyyy-MM-dd HH:mm:ss")):"尚未保存"}),(0,r.jsx)("button",{onClick:c,disabled:l||o,className:"px-4 py-2 bg-gray-200 text-gray-700 text-sm rounded-full hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:"保存草稿"}),(0,r.jsx)("button",{onClick:u,className:"px-4 py-2 bg-gray-200 text-gray-700 text-sm rounded-full hover:bg-gray-300 focus:outline-none",children:"草稿箱"}),(0,r.jsx)("button",{onClick:i,disabled:l||o||s,className:"px-4 py-2 bg-green-500 text-white text-sm rounded-full hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:s?"生成预览中...":"预览文章"}),(0,r.jsx)("button",{onClick:d,disabled:l||o,className:"px-4 py-2 bg-blue-500 text-white text-sm rounded-full hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:l?"提交中...":"发布文章"})]})};var O=a(8578);let A=(0,n.forwardRef)((e,t)=>{let{content:a,onChange:l,onSaveDraft:o,setUploadProgress:s}=e,i=(0,n.useRef)(null),d=(0,n.useRef)(null);return(0,n.useImperativeHandle)(t,()=>({getTextareaRef:()=>d.current})),(0,n.useEffect)(()=>{let e=async e=>{var t;let r=null==(t=e.clipboardData)?void 0:t.items;if(r){for(let t=0;t<r.length;t++)if(-1!==r[t].type.indexOf("image")){e.preventDefault();let n=r[t].getAsFile();if(!n)continue;try{null==s||s("上传图片中...");let e=c(),t=await e.uploadImage(n),r=d.current,i=r?r.selectionStart:-1,u="![图片](".concat(t,")"),g=B(a,u,i);l(g),null==s||s("图片上传成功!",3e3),o()}catch(e){console.error("上传图片失败:",e),null==s||s("图片上传失败",3e3)}break}}},t=e=>{if(e.metaKey||e.ctrlKey||"Delete"!==e.key&&"Backspace"!==e.key)return;let t=d.current;if(!t)return;let r=t.selectionStart;if(null===r||t.selectionStart!==t.selectionEnd)return;let n=t.scrollTop,i="Backspace"===e.key?r-1:r;if(i<0)return;let u=-1,g=-1,h=i;for(;h>=1;){if("!"===a[h-1]&&"["===a[h]){u=h-1;break}h--}if(u>=0){let e=0;for(h=u;h<a.length;h++)if("("===a[h]&&e++,")"===a[h]&&0==--e){g=h+1;break}}if(u>=0&&g>u&&i>=u&&i<=g){let r=a.substring(u,g).match(/\]\((.*?)(?:#|$)/);if(r&&r[1]){let a=r[1],i=t.value.substring(0,u)+t.value.substring(g);t.setSelectionRange(u,g),t.value=i,t.dispatchEvent(new InputEvent("input",{inputType:"deleteContentBackward",data:null,bubbles:!0,cancelable:!0})),l(i),setTimeout(()=>{t.selectionStart=u,t.selectionEnd=u,t.scrollTop=n,t.focus()},0),c().deleteImage(a),null==s||s("图片已删除",2e3),o(),e.preventDefault()}}},r=()=>{if(i.current){let a=i.current.querySelector("textarea");if(a)return d.current=a,a.addEventListener("paste",e),a.addEventListener("keydown",t),!0}return!1};if(!r()){let e=setTimeout(()=>{r()},500);return()=>clearTimeout(e)}return()=>{d.current&&(d.current.removeEventListener("paste",e),d.current.removeEventListener("keydown",t))}},[a,l,o,s]),(0,r.jsx)("div",{ref:i,className:"flex-1 w-full",children:(0,r.jsx)(O.Ay,{value:a,onChange:e=>l(e||""),height:window.innerHeight-100,preview:"edit",className:"editor-fullscreen h-full",hideToolbar:!1,textareaProps:{placeholder:"请输入文章内容...","aria-label":"可以粘贴图片（Ctrl+V）到编辑器中"}})})});A.displayName="MarkdownEditor";let B=(e,t,a)=>a>=0&&a<=e.length?e.slice(0,a)+t+e.slice(a):e+"\n"+t;var M=a(9345),F=a.n(M),H=a(5695),G=a(9641).Buffer;let z=["talk","project","blog"];function J(){let[e,t]=(0,n.useState)(""),[a,l]=(0,n.useState)(""),[s,i]=(0,n.useState)(z[0]),[d,u]=(0,n.useState)(E[7]),g=(0,H.useSearchParams)(),[h,f]=(0,n.useState)(!1),[m,p]=(0,n.useState)(!1),[b,w]=(0,n.useState)(!1),x=(0,n.useRef)(null),v=(0,n.useMemo)(()=>g.get("id")||"article-".concat(Date.now(),"-").concat(Math.random().toString(36).substring(2,7)),[g]),{isUploading:k,uploadProgress:S,setUploadProgress:N}=function(){let[e,t]=(0,n.useState)(!1),[a,r]=(0,n.useState)("");return{isUploading:e,uploadProgress:a,setUploadProgress:(0,n.useCallback)(function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3e3;r(e),e.includes("上传中")?t(!0):(t(!1),a>0&&setTimeout(()=>{r("")},a))},[]),clearUploadProgress:(0,n.useCallback)(()=>{r(""),t(!1)},[])}}(),{isAutoSaving:j,lastSaved:C,saveDraft:U,drafts:R,loadAllDrafts:O,switchToDraft:B,deleteDraft:M,createNewDraft:J,lastContentRef:K}=function(e){let{articleId:t,title:a,content:r,category:l,theme:o,onUpdateTitle:s,onUpdateContent:c,onUpdateCategory:i,onUpdateTheme:d}=e,[u,g]=(0,n.useState)(!1),[h,f]=(0,n.useState)(null),[m,p]=(0,n.useState)([]),b=(0,n.useRef)({title:"",content:"",theme:E[7],category:"talk"}),y="blog_draft_".concat(t),w=(0,n.useCallback)(()=>{g(!0);let e={title:a,content:r,category:l,lastSaved:new Date().toISOString(),theme:o};b.current={title:a,content:r,theme:o,category:l};let t=F().compressToUTF16(JSON.stringify(e));localStorage.setItem(y,t),f(new Date(e.lastSaved)),g(!1)},[a,r,l,o,y]);(0,n.useEffect)(()=>{let e=localStorage.getItem(y);if(e)try{let{title:t,content:a,category:r,theme:n,lastSaved:l}=JSON.parse(F().decompressFromUTF16(e)||"{}");s(t||""),c(a||""),i(r||"talk"),d(n||"cyberpunk"),l&&f(new Date(l))}catch(e){console.error("加载草稿失败:",e)}},[y,s,c,i,d]);let x=(0,n.useCallback)(()=>{let e=[];for(let t=0;t<localStorage.length;t++){let a=localStorage.key(t);if(a&&a.startsWith("blog_draft_"))try{let t=a.replace("blog_draft_",""),r=localStorage.getItem(a);if(r){let a=JSON.parse(F().decompressFromUTF16(r)||"{}");e.push({id:t,title:a.title||"无标题草稿",lastSaved:a.lastSaved||""})}}catch(e){console.error("解析草稿数据失败:",e)}}p(e)},[]),v=(0,n.useCallback)(e=>{w();let t=new URL(window.location.href);t.searchParams.set("id",e),window.location.href=t.toString()},[w]),k=(0,n.useCallback)(e=>{if(confirm("确定要删除此草稿吗？此操作不可恢复。")&&(localStorage.removeItem("blog_draft_".concat(e)),x(),e===t)){let e="article-".concat(Date.now(),"-").concat(Math.random().toString(36).substring(2,7)),t=new URL(window.location.href);t.searchParams.set("id",e),window.location.href=t.toString()}},[t,x]);return{isAutoSaving:u,lastSaved:h,saveDraft:w,drafts:m,loadAllDrafts:x,switchToDraft:v,deleteDraft:k,createNewDraft:(0,n.useCallback)(()=>{let e="article-".concat(Date.now(),"-").concat(Math.random().toString(36).substring(2,7)),t=new URL(window.location.href);t.searchParams.set("id",e),window.location.href=t.toString()},[]),lastContentRef:b}}({articleId:v,title:a,content:e,category:s,theme:d,onUpdateTitle:l,onUpdateContent:t,onUpdateCategory:i,onUpdateTheme:u});(0,n.useEffect)(()=>{let e=new URL(window.location.href);e.searchParams.set("id",v),window.history.replaceState({},"",e.toString())},[v]);let V=async()=>{if(!e||!a)return void alert("标题和内容不能为空");f(!0);try{let r=c();if(r instanceof o){let t={};e.replace(/!\[.*?\]\((.*?)(?:#.*?)?\)/g,(e,a)=>(t[a]=!0,e)),await Promise.all(r.getUploadedImages().map(async e=>{if(!e.content&&e.blobUrl&&t[e.blobUrl])try{let t=await fetch(e.blobUrl);if(t.ok){let a=await t.blob(),r=await a.arrayBuffer();e.content=G.from(r).toString("base64")}}catch(t){console.error("获取图片 ".concat(e.name," 内容失败:"),t)}}))}let n=e.replace(/!\[(.*?)\]\((.*?)#([^)]+)\)/g,(e,t,a,r)=>{let n=r.startsWith("/")?r:"/".concat(r);return"![".concat(t||"image","](").concat(n,")")}),i="_posts/".concat(a,".md"),u=await y({title:a,content:_(a,n,d,s),path:i});(null==u?void 0:u.url)&&(localStorage.removeItem("blog_draft_".concat(v)),t(""),l(""),alert("提交成功！PR链接：".concat(u.url)),window.open(u.url,"_blank"))}catch(e){alert("提交失败："+e.message)}finally{f(!1)}},W=(0,n.useCallback)(async()=>{if(!e||!a)return void alert("标题和内容不能为空");try{p(!0);let t=await I(e),r=P(a,t,d),n=await fetch("/api/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({html:r})});if(!n.ok)throw Error("服务器端创建预览失败");let{previewId:l}=await n.json();window.open("/api/preview/".concat(l),"_blank")}catch(e){console.error("生成预览失败:",e),alert("生成预览失败: "+e.message)}finally{p(!1)}},[a,e,d]);return(0,n.useEffect)(()=>{let e=setInterval(U,3e4);return()=>{clearInterval(e)}},[U]),(0,n.useEffect)(()=>{let t=t=>{let r=K.current.title!==a||K.current.content!==e||K.current.category!==s||K.current.theme!==d;if(j||r)return t.preventDefault(),t.returnValue="您有未保存的更改，确定要离开吗？",t.returnValue};return window.addEventListener("beforeunload",t),()=>{window.removeEventListener("beforeunload",t)}},[s,e,j,d,a]),(0,r.jsxs)("div",{className:"flex flex-col w-full min-h-screen",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between px-6 py-2 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 sticky top-0 z-10",children:[(0,r.jsx)(D,{title:a,onTitleChange:l,category:s,onCategoryChange:i,theme:d,onThemeChange:u,categories:z}),(0,r.jsx)(L,{isAutoSaving:j,lastSaved:C,uploadProgress:S,loading:h,isUploading:k,isGeneratingPreview:m,onSaveDraft:U,onGeneratePreview:W,onSubmit:V,onShowDraftList:()=>{O(),w(!b)}})]}),(0,r.jsx)(A,{ref:x,content:e,onChange:t,onSaveDraft:U,setUploadProgress:N}),(0,r.jsx)(T,{drafts:R,currentArticleId:v,showDraftList:b,onClose:()=>w(!1),onSwitchDraft:B,onDeleteDraft:M,onCreateNewDraft:J})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[827,766,62,565,441,684,358],()=>t(907)),_N_E=e.O()}]);