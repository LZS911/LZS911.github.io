<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/569ce4b8f30dc480-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/93f479601ee12b01-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/afd685b2833157f9.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-6281654836ffc620.js"/><script src="/_next/static/chunks/4bd1b696-66c7c23a79af63cb.js" async=""></script><script src="/_next/static/chunks/684-2dd5576fde2f1aef.js" async=""></script><script src="/_next/static/chunks/main-app-8a63285bca825cb3.js" async=""></script><script src="/_next/static/chunks/874-90f68e0a3827b559.js" async=""></script><script src="/_next/static/chunks/app/error-d036ecfd03716e30.js" async=""></script><script src="/_next/static/chunks/app/not-found-2113bbd7a2f55e8f.js" async=""></script><script src="/_next/static/chunks/app/loading-b73dd9bd22c3caa2.js" async=""></script><script src="/_next/static/chunks/766-dfd76e5b111fda64.js" async=""></script><script src="/_next/static/chunks/app/(article)/layout-120a8801c6045af4.js" async=""></script><script src="/_next/static/chunks/62-abd5adcc4de2f71a.js" async=""></script><script src="/_next/static/chunks/app/(article)/posts/%5Bslug%5D/page-3df7d22b1edb27cc.js" async=""></script><meta name="next-size-adjust" content=""/><title>Ai.Haibara codes</title><meta name="description" content="LZS Blog"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="96x96"/><script>document.querySelectorAll('body link[rel="icon"], body link[rel="apple-touch-icon"]').forEach(el => document.head.appendChild(el))</script><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="__variable_5cfdac __variable_9a8899 antialiased"><!--$--><html lang="en"><body class="__variable_5cfdac __variable_9a8899 antialiased"><div class="min-h-screen"><header class="text-white bg-black drop-shadow-2xl"><div class="mx-auto my-0 max-w-[960px] py-6 px-4 flex items-center"><div class="flex items-center"><img alt="Ai.Haibara" loading="lazy" width="100" height="100" decoding="async" data-nimg="1" class=" rounded-full" style="color:transparent" srcSet="/_next/image?url=%2Fassets%2Fblog%2Fauthors%2Fhaibara_2.jpg&amp;w=128&amp;q=75 1x, /_next/image?url=%2Fassets%2Fblog%2Fauthors%2Fhaibara_2.jpg&amp;w=256&amp;q=75 2x" src="/_next/image?url=%2Fassets%2Fblog%2Fauthors%2Fhaibara_2.jpg&amp;w=256&amp;q=75"/></div><div class="ml-6"><a class=" font-bold text-3xl" href="/">Ai.Haibara codes</a><div class="mt-2"><a class="p-1 rounded-sm text-xl mr-2 hover:border-b-2 border-lime-300" href="/">Home</a><a class="p-1 rounded-sm text-xl mr-2 hover:border-b-2 border-lime-300" href="/projects">Projects</a><a class="p-1 rounded-sm text-xl mr-2 hover:border-b-2 border-lime-300" href="/talks">Talks</a><a class="p-1 rounded-sm text-xl mr-2 hover:border-b-2 border-lime-300" href="/blogs">Blogs</a></div></div></div></header><main class="p-6 flex justify-center"><article><div class="flex justify-center font-[Arial] max-w-[864px] text-center"><h1 class="text-[2.5rem] font-bold bg-lime-300 px-5 py-2 rounded-sm text-shadow-lg leading-[1.1]">swc-vs-babel</h1></div><time dateTime="2023-03-18" class="text-center block my-4 text-sm opacity-60">March	18, 2023</time><section class="markdown-body-fancy max-w-3xl"><h2 id="babel"><a aria-hidden="true" tabindex="-1" href="#babel"><span class="icon icon-link"></span></a>babel</h2>
<p>关于 babel 的介绍: &#x3C;<a href="https://lzs911.github.io/posts/babe">https://lzs911.github.io/posts/babe</a></p>
<h2 id="swc"><a aria-hidden="true" tabindex="-1" href="#swc"><span class="icon icon-link"></span></a>swc</h2>
<p><a href="https://swc.rs/">swc</a> 是通过 <a href="https://www.rust-lang.org/">rust</a> 实现的一个类 babel 工具, 而且在 swc 的官网，很直白说自己和 babel 对标，swc 和 babel 命令可以相互替换，并且大部分的 babel 插件也已经实现。</p>
<p>对比 babel, swc 的最大优势就是快, 这是底层语言所造成的原因. 所以现在很多能用rust重写的工具都开始进行重写.</p>
<p>光说可能并不能具体的体会 swc 到底有多快, 所以准备同时使用 babel 以及 swc 实现一个简易版本的 <code>babel-import-plugin</code>, 也就是将 <code>import { A, B } from 'lib'</code> 转化成 <code>import A from lib/A; import B from lib/B;</code>.</p>
<h2 id="对比"><a aria-hidden="true" tabindex="-1" href="#对比"><span class="icon icon-link"></span></a>对比</h2>
<p>先来看下 babel 的实现</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">const</span> { traverse, parseSync, <span class="hljs-attr">types</span>: t } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"@babel/core"</span>);
<span class="hljs-keyword">const</span> generator = <span class="hljs-built_in">require</span>(<span class="hljs-string">"@babel/generator"</span>).<span class="hljs-property">default</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">transform</span> = (<span class="hljs-params">content</span>) => {
  <span class="hljs-keyword">const</span> ast = <span class="hljs-title function_">parseSync</span>(content);
  <span class="hljs-title function_">traverse</span>(ast, {
    <span class="hljs-title class_">ImportDeclaration</span>(_path) {
      <span class="hljs-keyword">const</span> { node } = _path;

      <span class="hljs-keyword">const</span> libraryName = node.<span class="hljs-property">source</span>.<span class="hljs-property">value</span>;

      <span class="hljs-keyword">const</span> _program = _path.<span class="hljs-title function_">findParent</span>(<span class="hljs-function">(<span class="hljs-params">p</span>) =></span> p.<span class="hljs-title function_">isProgram</span>());

      <span class="hljs-keyword">if</span> (
        node.<span class="hljs-property">specifiers</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">v</span>) =></span> v.<span class="hljs-property">type</span> === <span class="hljs-string">"ImportDefaultSpecifier"</span>)
          .<span class="hljs-property">length</span> > <span class="hljs-number">0</span>
      ) {
        <span class="hljs-keyword">return</span>;
      }

      node.<span class="hljs-property">specifiers</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">v</span>) =></span> {
        <span class="hljs-keyword">const</span> name = v.<span class="hljs-property">imported</span>?.<span class="hljs-property">name</span> ?? <span class="hljs-string">""</span>;

        _program.<span class="hljs-title function_">pushContainer</span>(
          <span class="hljs-string">"body"</span>,
          t.<span class="hljs-title function_">importDeclaration</span>(
            [t.<span class="hljs-title function_">importDefaultSpecifier</span>(t.<span class="hljs-title function_">identifier</span>(name))],
            t.<span class="hljs-title function_">stringLiteral</span>(<span class="hljs-string">`<span class="hljs-subst">${libraryName}</span>/lib/<span class="hljs-subst">${name}</span>`</span>)
          )
        );
      });

      _path.<span class="hljs-title function_">remove</span>();
      _path.<span class="hljs-title function_">skip</span>();
    },
  });

  <span class="hljs-keyword">const</span> out = <span class="hljs-title function_">generator</span>(ast)?.<span class="hljs-property">code</span>;
};
</code></pre>
<p>主要流程还是老三步:</p>
<ol>
<li>将原代码转化成 ast 树</li>
<li>遍历 ast, 处理符合条件的 import 语句, 将其转化成需要的格式, 同时使用 <code>program.pushContainer</code> 添加到原树中, 并且移除掉旧的节点.</li>
<li>将 ast 转化回字符串格式的代码.</li>
</ol>
<p>接下来看下 swc 的实现</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Visitor</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">"@swc/core/Visitor"</span>).<span class="hljs-property">default</span>;
<span class="hljs-keyword">const</span> { transformSync } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"@swc/core"</span>);

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PluginTransformImport</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Visitor</span> {
  <span class="hljs-title function_">visitModuleItems</span>(<span class="hljs-params">nodes</span>) {
    <span class="hljs-keyword">const</span> transformedNodes = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> node <span class="hljs-keyword">of</span> nodes) {
      <span class="hljs-keyword">const</span> { type, source, specifiers } = node;

      <span class="hljs-keyword">if</span> (type === <span class="hljs-string">"ImportDefaultSpecifier"</span>) {
        transformedNodes.<span class="hljs-title function_">push</span>(node);
        <span class="hljs-keyword">continue</span>;
      }

      specifiers.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">v</span>) =></span> {
        <span class="hljs-keyword">const</span> name = v.<span class="hljs-property">local</span>.<span class="hljs-property">value</span>;
        <span class="hljs-keyword">const</span> type = v.<span class="hljs-property">type</span>;

        <span class="hljs-keyword">if</span> (type === <span class="hljs-string">"ImportSpecifier"</span>) {
          <span class="hljs-keyword">const</span> newSpecifier = {
            ...v,
            <span class="hljs-attr">imported</span>: <span class="hljs-literal">null</span>,
            <span class="hljs-attr">type</span>: <span class="hljs-string">"ImportDefaultSpecifier"</span>,
          };
          <span class="hljs-keyword">const</span> value = <span class="hljs-string">`<span class="hljs-subst">${source.value}</span>/lib/<span class="hljs-subst">${name}</span>`</span>;

          <span class="hljs-keyword">const</span> copyNode = {
            ...node,
            <span class="hljs-attr">source</span>: {
              ...source,
              value,
            },
            <span class="hljs-attr">specifiers</span>: [newSpecifier],
            <span class="hljs-attr">type</span>: <span class="hljs-string">"ImportDeclaration"</span>,
          };

          transformedNodes.<span class="hljs-title function_">push</span>(copyNode);
        }
      });
    }
    <span class="hljs-keyword">return</span> transformedNodes;
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">transform</span> = (<span class="hljs-params">content</span>) => {
  <span class="hljs-keyword">const</span> code =
    <span class="hljs-title function_">transformSync</span>(content, {
      <span class="hljs-attr">plugin</span>: <span class="hljs-function">(<span class="hljs-params">v</span>) =></span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PluginTransformImport</span>().<span class="hljs-title function_">visitProgram</span>(v),
    })?.<span class="hljs-property">code</span> ?? <span class="hljs-string">""</span>;
};

</code></pre>
<p>具体流程:</p>
<ol>
<li>新建一个类, 并且继承 <code>@swc/core</code> 提供的 <code>Visitor</code> 类.</li>
<li>实现对应节点类型的处理函数, 这里是 <code>visitModuleItems</code>, 这里与 babel 不同的是这里是通过函数的返回值来 replace 掉旧的节点</li>
<li>调用 transformSync, 将实现的类作为插件的形式传入</li>
</ol>
<p>下面是两者在对 10000 条 import 语句下的表现:</p>
<p><img src="/assets/swc_vs_babel/example-1.png" alt="alt">
<img src="/assets/swc_vs_babel/example-1.png" alt="alt"></p></section></article><!--$--><!--/$--><!--$--><!--/$--></main><footer class="bg-neutral-50 border-t border-neutral-200 text-center text-xs opacity-50 py-4">© 2022 - <!-- -->2025<a rel="noopener noreferrer" class="hover:underline hover:bg-indigo" href="https://github.com/LZS911" target="_blank">, LZS_911</a>, build with<!-- --> <a rel="noopener noreferrer" class="underline hover:bg-indigo" href="https://nextjs.org/" target="_blank">Next.js</a> <!-- -->and<!-- --> <a rel="noopener noreferrer" class="underline hover:bg-indigo" href="https://pages.github.com/?(null)" target="_blank">GitHub Pages</a></footer></div><!--/$--><script src="/_next/static/chunks/webpack-6281654836ffc620.js" async=""></script></body></html><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[7555,[],\"\"]\n3:I[1901,[\"874\",\"static/chunks/874-90f68e0a3827b559.js\",\"39\",\"static/chunks/app/error-d036ecfd03716e30.js\"],\"default\"]\n4:I[1295,[],\"\"]\n5:I[9543,[\"874\",\"static/chunks/874-90f68e0a3827b559.js\",\"345\",\"static/chunks/app/not-found-2113bbd7a2f55e8f.js\"],\"default\"]\n8:I[9665,[],\"MetadataBoundary\"]\na:I[9665,[],\"OutletBoundary\"]\nd:I[4911,[],\"AsyncMetadataOutlet\"]\nf:I[8460,[\"209\",\"static/chunks/app/loading-b73dd9bd22c3caa2.js\"],\"default\"]\n10:I[9665,[],\"ViewportBoundary\"]\n12:I[6614,[],\"\"]\n:HL[\"/_next/static/media/569ce4b8f30dc480-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/93f479601ee12b01-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/css/afd685b2833157f9.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"VQMikkFLjz8rKFgMU-oOZ\",\"p\":\"\",\"c\":[\"\",\"posts\",\"swc-vs-babel\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"(article)\",{\"children\":[\"posts\",{\"children\":[[\"slug\",\"swc-vs-babel\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/afd685b2833157f9.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"__variable_5cfdac __variable_9a8899 antialiased\",\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$3\",\"errorStyles\":[],\"errorScripts\":[],\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"$L5\",null,{}],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]}]]}],{\"children\":[\"(article)\",[\"$\",\"$1\",\"c\",{\"children\":[null,\"$L6\"]}],{\"children\":[\"posts\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"slug\",\"swc-vs-babel\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L7\",[\"$\",\"$L8\",null,{\"children\":\"$L9\"}],null,[\"$\",\"$La\",null,{\"children\":[\"$Lb\",\"$Lc\",[\"$\",\"$Ld\",null,{\"promise\":\"$@e\"}]]}]]}],{},null,false]},null,false]},null,false]},null,false]},[[\"$\",\"$Lf\",\"l\",{}],[],[]],false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"AVmkYdaHZrwR2oy3DjSHI\",{\"children\":[[\"$\",\"$L10\",null,{\"children\":\"$L11\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}],null]}],false]],\"m\":\"$undefined\",\"G\":[\"$12\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"13:I[4467,[\"874\",\"static/chunks/874-90f68e0a3827b559.js\",\"766\",\"static/chunks/766-dfd76e5b111fda64.js\",\"651\",\"static/chunks/app/(article)/layout-120a8801c6045af4.js\"],\"default\"]\n14:\"$Sreact.suspense\"\n15:I[4911,[],\"AsyncMetadata\"]\n6:[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"__variable_5cfdac __variable_9a8899 antialiased\",\"children\":[[\"$\",\"div\",null,{\"className\":\"min-h-screen\",\"children\":[[\"$\",\"$L13\",null,{}],[\"$\",\"main\",null,{\"className\":\"p-6 flex justify-center\",\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}],[\"$\",\"footer\",null,{\"className\":\"bg-neutral-50 border-t border-neutral-200 text-center text-xs opacity-50 py-4\",\"children\":[\"© 2022 - \",2025,[\"$\",\"a\",null,{\"rel\":\"noopener noreferrer\",\"className\":\"hover:underline hover:bg-indigo\",\"href\":\"https://github.com/LZS911\",\"target\":\"_blank\",\"children\":\", LZS_911\"}],\", build with\",\" \",[\"$\",\"a\",null,{\"rel\":\"noopener noreferrer\",\"className\":\"underline hover:bg-indigo\",\"href\":\"https://nextjs.org/\",\"target\":\"_blank\",\"children\":\"Next.js\"}],\" \",\"and\",\" \",[\"$\",\"a\",null,{\"rel\":\"noopener noreferrer\",\"className\":\"underline hover:bg-indigo\",\"href\":\"https://pages.github.com/?(null)\",\"target\":\"_blank\",\"children\":\"GitHub Pages\"}]]}]]}],false]}]}]\n9:[\"$\",\"$14\",null,{\"fallback\":null,\"children\":[\"$\",\"$L15\",null,{\"promise\":\"$@16\"}]}]\n"])</script><script>self.__next_f.push([1,"c:null\n"])</script><script>self.__next_f.push([1,"17:I[5099,[\"766\",\"static/chunks/766-dfd76e5b111fda64.js\",\"62\",\"static/chunks/62-abd5adcc4de2f71a.js\",\"520\",\"static/chunks/app/(article)/posts/%5Bslug%5D/page-3df7d22b1edb27cc.js\"],\"ThemeLoader\"]\n18:T21c7,"])</script><script>self.__next_f.push([1,"\u003ch2 id=\"babel\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#babel\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003ebabel\u003c/h2\u003e\n\u003cp\u003e关于 babel 的介绍: \u0026#x3C;\u003ca href=\"https://lzs911.github.io/posts/babe\"\u003ehttps://lzs911.github.io/posts/babe\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"swc\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#swc\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eswc\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://swc.rs/\"\u003eswc\u003c/a\u003e 是通过 \u003ca href=\"https://www.rust-lang.org/\"\u003erust\u003c/a\u003e 实现的一个类 babel 工具, 而且在 swc 的官网，很直白说自己和 babel 对标，swc 和 babel 命令可以相互替换，并且大部分的 babel 插件也已经实现。\u003c/p\u003e\n\u003cp\u003e对比 babel, swc 的最大优势就是快, 这是底层语言所造成的原因. 所以现在很多能用rust重写的工具都开始进行重写.\u003c/p\u003e\n\u003cp\u003e光说可能并不能具体的体会 swc 到底有多快, 所以准备同时使用 babel 以及 swc 实现一个简易版本的 \u003ccode\u003ebabel-import-plugin\u003c/code\u003e, 也就是将 \u003ccode\u003eimport { A, B } from 'lib'\u003c/code\u003e 转化成 \u003ccode\u003eimport A from lib/A; import B from lib/B;\u003c/code\u003e.\u003c/p\u003e\n\u003ch2 id=\"对比\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#对比\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003e对比\u003c/h2\u003e\n\u003cp\u003e先来看下 babel 的实现\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { traverse, parseSync, \u003cspan class=\"hljs-attr\"\u003etypes\u003c/span\u003e: t } = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"@babel/core\"\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e generator = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"@babel/generator\"\u003c/span\u003e).\u003cspan class=\"hljs-property\"\u003edefault\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etransform\u003c/span\u003e = (\u003cspan class=\"hljs-params\"\u003econtent\u003c/span\u003e) =\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e ast = \u003cspan class=\"hljs-title function_\"\u003eparseSync\u003c/span\u003e(content);\n  \u003cspan class=\"hljs-title function_\"\u003etraverse\u003c/span\u003e(ast, {\n    \u003cspan class=\"hljs-title class_\"\u003eImportDeclaration\u003c/span\u003e(_path) {\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { node } = _path;\n\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e libraryName = node.\u003cspan class=\"hljs-property\"\u003esource\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003evalue\u003c/span\u003e;\n\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e _program = _path.\u003cspan class=\"hljs-title function_\"\u003efindParent\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ep\u003c/span\u003e) =\u003e\u003c/span\u003e p.\u003cspan class=\"hljs-title function_\"\u003eisProgram\u003c/span\u003e());\n\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\n        node.\u003cspan class=\"hljs-property\"\u003especifiers\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003efilter\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ev\u003c/span\u003e) =\u003e\u003c/span\u003e v.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\"ImportDefaultSpecifier\"\u003c/span\u003e)\n          .\u003cspan class=\"hljs-property\"\u003elength\u003c/span\u003e \u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n      ) {\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\n      }\n\n      node.\u003cspan class=\"hljs-property\"\u003especifiers\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eforEach\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ev\u003c/span\u003e) =\u003e\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e name = v.\u003cspan class=\"hljs-property\"\u003eimported\u003c/span\u003e?.\u003cspan class=\"hljs-property\"\u003ename\u003c/span\u003e ?? \u003cspan class=\"hljs-string\"\u003e\"\"\u003c/span\u003e;\n\n        _program.\u003cspan class=\"hljs-title function_\"\u003epushContainer\u003c/span\u003e(\n          \u003cspan class=\"hljs-string\"\u003e\"body\"\u003c/span\u003e,\n          t.\u003cspan class=\"hljs-title function_\"\u003eimportDeclaration\u003c/span\u003e(\n            [t.\u003cspan class=\"hljs-title function_\"\u003eimportDefaultSpecifier\u003c/span\u003e(t.\u003cspan class=\"hljs-title function_\"\u003eidentifier\u003c/span\u003e(name))],\n            t.\u003cspan class=\"hljs-title function_\"\u003estringLiteral\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${libraryName}\u003c/span\u003e/lib/\u003cspan class=\"hljs-subst\"\u003e${name}\u003c/span\u003e`\u003c/span\u003e)\n          )\n        );\n      });\n\n      _path.\u003cspan class=\"hljs-title function_\"\u003eremove\u003c/span\u003e();\n      _path.\u003cspan class=\"hljs-title function_\"\u003eskip\u003c/span\u003e();\n    },\n  });\n\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e out = \u003cspan class=\"hljs-title function_\"\u003egenerator\u003c/span\u003e(ast)?.\u003cspan class=\"hljs-property\"\u003ecode\u003c/span\u003e;\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e主要流程还是老三步:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e将原代码转化成 ast 树\u003c/li\u003e\n\u003cli\u003e遍历 ast, 处理符合条件的 import 语句, 将其转化成需要的格式, 同时使用 \u003ccode\u003eprogram.pushContainer\u003c/code\u003e 添加到原树中, 并且移除掉旧的节点.\u003c/li\u003e\n\u003cli\u003e将 ast 转化回字符串格式的代码.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e接下来看下 swc 的实现\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eVisitor\u003c/span\u003e = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"@swc/core/Visitor\"\u003c/span\u003e).\u003cspan class=\"hljs-property\"\u003edefault\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { transformSync } = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"@swc/core\"\u003c/span\u003e);\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePluginTransformImport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"hljs-title class_ inherited__\"\u003eVisitor\u003c/span\u003e {\n  \u003cspan class=\"hljs-title function_\"\u003evisitModuleItems\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003enodes\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e transformedNodes = [];\n\n    \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e node \u003cspan class=\"hljs-keyword\"\u003eof\u003c/span\u003e nodes) {\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { type, source, specifiers } = node;\n\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (type === \u003cspan class=\"hljs-string\"\u003e\"ImportDefaultSpecifier\"\u003c/span\u003e) {\n        transformedNodes.\u003cspan class=\"hljs-title function_\"\u003epush\u003c/span\u003e(node);\n        \u003cspan class=\"hljs-keyword\"\u003econtinue\u003c/span\u003e;\n      }\n\n      specifiers.\u003cspan class=\"hljs-title function_\"\u003eforEach\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ev\u003c/span\u003e) =\u003e\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e name = v.\u003cspan class=\"hljs-property\"\u003elocal\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003evalue\u003c/span\u003e;\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e type = v.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e;\n\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (type === \u003cspan class=\"hljs-string\"\u003e\"ImportSpecifier\"\u003c/span\u003e) {\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e newSpecifier = {\n            ...v,\n            \u003cspan class=\"hljs-attr\"\u003eimported\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\n            \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"ImportDefaultSpecifier\"\u003c/span\u003e,\n          };\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e value = \u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${source.value}\u003c/span\u003e/lib/\u003cspan class=\"hljs-subst\"\u003e${name}\u003c/span\u003e`\u003c/span\u003e;\n\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e copyNode = {\n            ...node,\n            \u003cspan class=\"hljs-attr\"\u003esource\u003c/span\u003e: {\n              ...source,\n              value,\n            },\n            \u003cspan class=\"hljs-attr\"\u003especifiers\u003c/span\u003e: [newSpecifier],\n            \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"ImportDeclaration\"\u003c/span\u003e,\n          };\n\n          transformedNodes.\u003cspan class=\"hljs-title function_\"\u003epush\u003c/span\u003e(copyNode);\n        }\n      });\n    }\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e transformedNodes;\n  }\n}\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etransform\u003c/span\u003e = (\u003cspan class=\"hljs-params\"\u003econtent\u003c/span\u003e) =\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e code =\n    \u003cspan class=\"hljs-title function_\"\u003etransformSync\u003c/span\u003e(content, {\n      \u003cspan class=\"hljs-attr\"\u003eplugin\u003c/span\u003e: \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ev\u003c/span\u003e) =\u003e\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePluginTransformImport\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003evisitProgram\u003c/span\u003e(v),\n    })?.\u003cspan class=\"hljs-property\"\u003ecode\u003c/span\u003e ?? \u003cspan class=\"hljs-string\"\u003e\"\"\u003c/span\u003e;\n};\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e具体流程:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e新建一个类, 并且继承 \u003ccode\u003e@swc/core\u003c/code\u003e 提供的 \u003ccode\u003eVisitor\u003c/code\u003e 类.\u003c/li\u003e\n\u003cli\u003e实现对应节点类型的处理函数, 这里是 \u003ccode\u003evisitModuleItems\u003c/code\u003e, 这里与 babel 不同的是这里是通过函数的返回值来 replace 掉旧的节点\u003c/li\u003e\n\u003cli\u003e调用 transformSync, 将实现的类作为插件的形式传入\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e下面是两者在对 10000 条 import 语句下的表现:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/swc_vs_babel/example-1.png\" alt=\"alt\"\u003e\n\u003cimg src=\"/assets/swc_vs_babel/example-1.png\" alt=\"alt\"\u003e\u003c/p\u003e"])</script><script>self.__next_f.push([1,"7:[\"$\",\"article\",null,{\"children\":[[\"$\",\"div\",null,{\"className\":\"flex justify-center font-[Arial] max-w-[864px] text-center\",\"children\":[\"$\",\"h1\",null,{\"className\":\"text-[2.5rem] font-bold bg-lime-300 px-5 py-2 rounded-sm text-shadow-lg leading-[1.1]\",\"children\":\"swc-vs-babel\"}]}],[\"$\",\"time\",null,{\"dateTime\":\"2023-03-18\",\"className\":\"text-center block my-4 text-sm opacity-60\",\"children\":\"March\\t18, 2023\"}],[null,[\"$\",\"$L17\",null,{\"theme\":\"fancy\"}],[\"$\",\"section\",null,{\"className\":\"markdown-body-fancy max-w-3xl\",\"dangerouslySetInnerHTML\":{\"__html\":\"$18\"}}]],null]}]\n"])</script><script>self.__next_f.push([1,"11:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\nb:null\n"])</script><script>self.__next_f.push([1,"16:{\"metadata\":[[\"$\",\"title\",\"0\",{\"children\":\"Ai.Haibara codes\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"LZS Blog\"}],[\"$\",\"link\",\"2\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"96x96\"}]],\"error\":null,\"digest\":\"$undefined\"}\ne:{\"metadata\":\"$16:metadata\",\"error\":null,\"digest\":\"$undefined\"}\n"])</script></body></html>